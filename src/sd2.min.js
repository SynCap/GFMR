var sd2 = sd2 || {};
sd2.converter = function() {
    var k, l, r, t = 0;
    this.makeHtml = function(a) {
        k = [];
        l = [];
        r = [];
        a = a.replace(/\r\n/g, "\n");
        a = a.replace(/\r/g, "\n");
        a = G("\n\n" + a + "\n\n");
        a = a.replace(/~/g, "~T");
        a = a.replace(/\$/g, "~D");
        a = z(a);
        a = a.replace(/^[ \t]+$/mg, "");
        a = H(a);
        a = A(a);
        a = I(a);
        a = u(a);
        a = B(a);
        a = a.replace(/~D/g, "$$");
        return a = a.replace(/~T/g, "~")
    };
    var G = function(a) {
            return a.replace(/^(```|~+)\s*([^\n]*)(([^\n]*\n)*?)\1\n/mg, function(a, e, d, b) {
                return "<pre><code" + ("" != (s = d.trim()) ? ' class="' + s + '"' : "") + ">" + b.replace(/</g, "&lt;").trim() +
                    "</code></pre>"
            })
        },
        H = function(a) {
            function c(a, c, b, g) {
                c = c.replace(/[|] *$/m, "");
                b = b.replace(/[|] *$/m, "");
                g = g.replace(/[|] *$/m, "");
                a = [];
                var h = b.split(/[ ]*[|][ ]*/);
                for (b = 0; b < h.length; b++) {
                    var f = h[b];
                    f.match(/^ *-+: *$/) ? a[b] = ' align="right"' : f.match(/^ *:-+: *$/) ? a[b] = ' align="center"' : f.match(/^ *:-+ *$/) ? a[b] = ' align="left"' : a[b] = ""
                }
                f = c.split(/ *[|] */);
                c = f.length;
                h = "<table>\n<thead>\n<tr>\n";
                for (b = 0; b < f.length; b++) h += "  <th" + a[b] + ">" + f[b].trim() + "</th>\n";
                h += "</tr>\n";
                h += "</thead>\n";
                g = g.replace(/(^\n*|\n*$)/g,
                    "").split("\n");
                h += "<tbody>\n";
                for (f = 0; f < g.length; f++) {
                    for (var k = g[f].split(/ *[|] */, c); k.length < c;) k.push("");
                    h += "<tr>\n";
                    for (b = 0; b < k.length; b++) h += "  <td" + a[b] + ">" + k[b].trim() + "</td>\n";
                    h += "</tr>\n"
                }
                return h += "</tbody>\n</table>\n"
            }
            a = a.replace(/^[ ]{0,3}[|]([^\n]+)\n[ ]{0,3}[|]([ ]*[-:]+[-| :]*)\n((?:(?=([ ]*[|][^\n]*\n))\4)*)/mg, function(a, d, b, g) {
                g = g.replace(/^ *[|]/mg, "");
                return c(a, d, b, g)
            });
            return a = a.replace(/^[ ]{0,3}(\S[^\n]*[|][^\n]*)\n[ ]{0,3}([-:]+[ ]*[|][-| :]*)\n((?:(?=([^\n]*[|][^\n]*\n))\4)*)/mg,
                c)
        },
        I = function(a) {
            return a = a.replace(/^[ ]{0,3}\[(.+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?[ \t]*\n?[ \t]*(?:(\n*)["(](.+?)[")][ \t]*)?(?:\n+)/gm, function(a, e, d, b, g) {
                e = e.toLowerCase();
                k[e] = C(d);
                if (b) return b + g;
                g && (l[e] = g.replace(/"/g, "&quot;"));
                return ""
            })
        },
        A = function(a) {
            a = a.replace(/\n/g, "\n\n");
            a = a.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del)\b[^\r]*?\n<\/\2>[ \t]*(?=\n+))/gm, p);
            a = a.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math)\b[^\r]*?.*<\/\2>[ \t]*(?=\n+)\n)/gm,
                p);
            a = a.replace(/(\n[ ]{0,3}(<(hr)\b([^<>])*?\/?>)[ \t]*(?=\n{2,}))/g, p);
            a = a.replace(/(\n\n[ ]{0,3}<!(--[^\r]*?--\s*)+>[ \t]*(?=\n{2,}))/g, p);
            a = a.replace(/(?:\n\n)([ ]{0,3}(?:<([?%])[^\r]*?\2>)[ \t]*(?=\n{2,}))/g, p);
            return a = a.replace(/\n\n/g, "\n")
        },
        p = function(a, c) {
            var e;
            e = c.replace(/\n\n/g, "\n");
            e = e.replace(/^\n/, "");
            e = e.replace(/\n+$/g, "");
            return e = "\n\n~K" + (r.push(e) - 1) + "K\n\n"
        },
        u = function(a) {
            a = J(a);
            var c = m("<hr />");
            a = a.replace(/^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$/gm, c);
            a = a.replace(/^[ ]{0,2}([ ]?-[ ]?){3,}[ \t]*$/gm,
                c);
            a = a.replace(/^[ ]{0,2}([ ]?_[ ]?){3,}[ \t]*$/gm, c);
            a = D(a);
            a = K(a);
            a = L(a);
            a = A(a);
            a = a.replace(/^\n+/g, "");
            a = a.replace(/\n+$/g, "");
            var e = a.split(/\n{2,}/g);
            a = [];
            for (var c = e.length, d = 0; d < c; d++) {
                var b = e[d];
                0 <= b.search(/~K(\d+)K/g) ? a.push(b) : 0 <= b.search(/\S/) && (b = q(b), b = b.replace(/^([ \t]*)/g, "<p>"), b += "</p>", a.push(b))
            }
            c = a.length;
            for (d = 0; d < c; d++)
                for (; 0 <= a[d].search(/~K(\d+)K/);) e = r[RegExp.$1], e = e.replace(/\$/g, "$$$$"), a[d] = a[d].replace(/~K\d+K/, e);
            return a = a.join("\n\n")
        },
        q = function(a) {
            a = M(a);
            a = N(a);
            a = a.replace(/\\(\\)/g, v);
            a = a.replace(/\\([`*_{}\[\]()>#+-.!])/g, v);
            a = a.replace(/(!\[(.*?)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g, E);
            a = a.replace(/(!\[(.*?)\]\s?\([ \t]*()<?(\S+?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g, E);
            a = a.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g, w);
            a = a.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\]\([ \t]*()<?(.*?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g, w);
            a = a.replace(/(\[([^\[\]]+)\])()()()()()/g, w);
            a = O(a);
            a = C(a);
            a = a.replace(/(\*\*|__)(?=\S)([^\r]*?\S[\*_]*)\1/g,
                "<strong>$2</strong>");
            a = a.replace(/(\*|_)(?=\S)([^\r]*?\S)\1/g, "<em>$2</em>");
            return a = a.replace(/  +\n/g, " <br />\n")
        },
        N = function(a) {
            return a = a.replace(/(<[a-z\/!$]("[^"]*"|'[^']*'|[^'">])*>|<!(--.*?--\s*)+>)/gi, function(a) {
                a = a.replace(/(.)<\/?code>(?=.)/g, "$1`");
                return a = n(a, "\\`*_")
            })
        },
        w = function(a, c, e, d, b, g, h, f) {
            void 0 == f && (f = "");
            a = d.toLowerCase();
            if ("" == b)
                if ("" == a && (a = e.toLowerCase().replace(/ ?\n/g, " ")), void 0 != k[a]) b = k[a], void 0 != l[a] && (f = l[a]);
                else if (-1 < c.search(/\(\s*\)$/m)) b = "";
            else return c;
            b = n(b, "*_");
            c = '<a href="' + b + '"';
            "" != f && (f = f.replace(/"/g, "&quot;"), f = n(f, "*_"), c += ' title="' + f + '"');
            return c + (">" + e + "</a>")
        },
        E = function(a, c, e, d, b, g, h, f) {
            a = e;
            d = d.toLowerCase();
            f || (f = "");
            if ("" == b)
                if ("" == d && (d = a.toLowerCase().replace(/ ?\n/g, " ")), void 0 != k[d]) b = k[d], void 0 != l[d] && (f = l[d]);
                else return c;
            a = a.replace(/"/g, "&quot;");
            b = n(b, "*_");
            c = '<img src="' + b + '" alt="' + a + '"';
            f = f.replace(/"/g, "&quot;");
            f = n(f, "*_");
            return c = c + (' title="' + f + '"') + " />"
        },
        J = function(a) {
            a = a.replace(/^(.+)[ \t]*\n=+[ \t]*\n+/gm,
                function(a, e) {
                    return m("<h1>" + q(e) + "</h1>")
                });
            a = a.replace(/^(.+)[ \t]*\n-+[ \t]*\n+/gm, function(a, e) {
                return m("<h2>" + q(e) + "</h2>")
            });
            return a = a.replace(/^(\#{1,6})[ \t]*(.+?)[ \t]*\#*\n+/gm, function(a, e, d) {
                a = e.length;
                return m("<h" + a + ">" + q(d) + "</h" + a + ">")
            })
        },
        x, D = function(a) {
            a += "~0";
            var c = /^(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm;
            t ? a = a.replace(c, function(a, c, b) {
                a = c;
                b = -1 < b.search(/[*+-]/g) ? "ul" : "ol";
                a = a.replace(/\n{2,}/g, "\n\n\n");
                a = x(a);
                a = a.replace(/\s+$/,
                    "");
                return "<" + b + ">" + a + "</" + b + ">\n"
            }) : (c = /(\n\n|^\n?)(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/g, a = a.replace(c, function(a, c, b, g) {
                a = b;
                g = -1 < g.search(/[*+-]/g) ? "ul" : "ol";
                a = a.replace(/\n{2,}/g, "\n\n\n");
                a = x(a);
                return c + "<" + g + ">\n" + a + "</" + g + ">\n"
            }));
            return a = a.replace(/~0/, "")
        };
    x = function(a) {
        t++;
        a = a.replace(/\n{2,}$/, "\n");
        a = (a + "~0").replace(/(\n)?(^[ \t]*)([*+-]|\d+[.])[ \t]+([^\r]+?(\n{1,2}))(?=\n*(~0|\2([*+-]|\d+[.])[ \t]+))/gm, function(a, e, d, b, g) {
            a = g;
            e ||
                -1 < a.search(/\n{2,}/) ? a = u(y(a)) : (a = D(y(a)), a = a.replace(/\n$/, ""), a = q(a));
            return "<li>" + a + "</li>\n"
        });
        a = a.replace(/~0/g, "");
        t--;
        return a
    };
    var K = function(a) {
            a = (a + "~0").replace(/(?:\n\n|^)((?:(?:[ ]{4}|\t).*\n+)+)(\n*[ ]{0,3}[^ \t\n]|(?=~0))/g, function(a, e, d) {
                a = F(y(e));
                a = z(a);
                a = a.replace(/^\n+/g, "");
                a = a.replace(/\n+$/g, "");
                a = "<pre><code>" + a + "\n</code></pre>";
                return m(a) + d
            });
            return a = a.replace(/~0/, "")
        },
        m = function(a) {
            a = a.replace(/(^\n+|\n+$)/g, "");
            return "\n\n~K" + (r.push(a) - 1) + "K\n\n"
        },
        M = function(a) {
            return a =
                a.replace(/(^|[^\\])(`+)([^\r]*?[^`])\2(?!`)/gm, function(a, e, d, b, g) {
                    a = b.replace(/^([ \t]*)/g, "");
                    a = a.replace(/[ \t]*$/g, "");
                    a = F(a);
                    return e + "<code>" + a + "</code>"
                })
        },
        F = function(a) {
            a = a.replace(/&/g, "&amp;");
            a = a.replace(/</g, "&lt;");
            a = a.replace(/>/g, "&gt;");
            return a = n(a, "*_{}[]\\", !1)
        },
        L = function(a) {
            return a = a.replace(/((^[ \t]*>[ \t]?.+\n(.+\n)*\n*)+)/gm, function(a, e) {
                var d;
                d = e.replace(/^[ \t]*>[ \t]?/gm, "~0");
                d = d.replace(/~0/g, "");
                d = d.replace(/^[ \t]+$/gm, "");
                d = u(d);
                d = d.replace(/(^|\n)/g, "$1  ");
                d =
                    d.replace(/(\s*<pre>[^\r]+?<\/pre>)/gm, function(a, e) {
                        var c;
                        c = e.replace(/^  /mg, "~0");
                        return c = c.replace(/~0/g, "")
                    });
                return m("<blockquote>\n" + d + "\n</blockquote>")
            })
        },
        C = function(a) {
            a = a.replace(/&(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/g, "&amp;");
            return a = a.replace(/<(?![a-z\/?\$!])/gi, "&lt;")
        },
        O = function(a) {
            a = a.replace(/<((https?|ftp|dict):[^'">\s]+)>/gi, '<a href="$1">$1</a>');
            return a = a.replace(/<(?:mailto:)?([-.\w]+\@[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+)>/gi, function(a, e) {
                return P(B(e))
            })
        },
        P = function(a) {
            var c = [function(a) {
                return "&#" + a.charCodeAt(0) + ";"
            }, function(a) {
                a = a.charCodeAt(0);
                return "&#x" + ("0123456789ABCDEF".charAt(a >> 4) + "0123456789ABCDEF".charAt(a & 15)) + ";"
            }, function(a) {
                return a
            }];
            a = ("mailto:" + a).replace(/./g, function(a) {
                if ("@" == a) a = c[Math.floor(2 * Math.random())](a);
                else if (":" != a) {
                    var d = Math.random();
                    a = 0.9 < d ? c[2](a) : 0.45 < d ? c[1](a) : c[0](a)
                }
                return a
            });
            a = '<a href="' + a + '">' + a + "</a>";
            return a = a.replace(/">.+:/g, '">')
        },
        B = function(a) {
            return a = a.replace(/~E(\d+)E/g, function(a, e) {
                var d = parseInt(e);
                return String.fromCharCode(d)
            })
        },
        y = function(a) {
            a = a.replace(/^(\t|[ ]{1,4})/gm, "~0");
            return a = a.replace(/~0/g, "")
        },
        z = function(a) {
            a = a.replace(/\t(?=\t)/g, "    ");
            a = a.replace(/\t/g, "~A~B");
            a = a.replace(/~B(.+?)~A/g, function(a, e, d) {
                a = e;
                e = 4 - a.length % 4;
                for (d = 0; d < e; d++) a += " ";
                return a
            });
            a = a.replace(/~A/g, "    ");
            return a = a.replace(/~B/g, "")
        },
        n = function(a, c, e) {
            c = "([" + c.replace(/([\[\]\\])/g, "\\$1") + "])";
            e && (c = "\\\\" + c);
            return a = a.replace(RegExp(c, "g"), v)
        },
        v = function(a, c) {
            return "~E" + c.charCodeAt(0) + "E"
        }
};
